"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[6933],{2202:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>s,default:()=>h,frontMatter:()=>a,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"tutorial/pub/archive/dockers_v2","title":"Docker (v2)","description":"This feature is in alpha state.","source":"@site/docs/tutorial/pub/archive/dockers_v2.mdx","sourceDirName":"tutorial/pub/archive","slug":"/tutorial/pub/archive/dockers_v2","permalink":"/kmdo/docs/tutorial/pub/archive/dockers_v2","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Docker Digests","permalink":"/kmdo/docs/tutorial/pub/archive/docker_digests"},"next":{"title":"Docker Images with Ko","permalink":"/kmdo/docs/tutorial/pub/archive/ko"}}');var o=i(4848),r=i(8453);const a={},s="Docker (v2)",l={},d=[{value:"Customization",id:"customization",level:2},{value:"Testing locally",id:"testing-locally",level:2},{value:"How it works",id:"how-it-works",level:2},{value:"The Docker build context",id:"the-docker-build-context",level:3},{value:"Setting up a builder",id:"setting-up-a-builder",level:2}];function c(e){const n={admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",strong:"strong",...(0,r.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"docker-v2",children:"Docker (v2)"})}),"\n",(0,o.jsx)(n.admonition,{title:'"alpha "',type:"warning",children:(0,o.jsxs)(n.p,{children:["This feature is in ",(0,o.jsx)(n.em,{children:"alpha"})," state.\nIt will be improved until its deemed stable, at which point we'll\nofficially deprecate ",(0,o.jsx)(n.code,{children:"dockers"})," and ",(0,o.jsx)(n.code,{children:"docker_manifests"})," in preparations for\nKmdo v3, which should take over both of them."]})}),"\n",(0,o.jsxs)(n.p,{children:["This feature uses ",(0,o.jsx)(n.code,{children:"docker buildx"})," to build multi-arch manifests,\nreusing the previously built binaries and/or packages."]}),"\n",(0,o.jsx)(n.h2,{id:"customization",children:"Customization"}),"\n",(0,o.jsx)(n.p,{children:"Here's a commented out configuration:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",metastring:'title=".kmdopkg.yaml"',children:'dockers_v2:\n  # You can have multiple Docker images.\n  - #\n    # ID of the image, needed if you want to filter by it later on (e.g. on custom publishers).\n    # Default: project name\n    id: myimg\n\n    # Path to the Dockerfile (from the project root).\n    #\n    # Default: \'Dockerfile\'.\n    # Templates: allowed.\n    dockerfile: "{{ .Env.DOCKERFILE }}"\n\n    # IDs to filter the binaries/packages.\n    #\n    # Make sure to only include the IDs of binaries you want to `COPY` in your\n    # Dockerfile.\n    #\n    # If you include IDs that don\'t exist or are not available for the current\n    # architecture being built, the build of the image will be skipped.\n    ids:\n      - mybuild\n      - mynfpm\n\n    # Image names.\n    #\n    # Empty image names are ignored.\n    #\n    # Templates: allowed.\n    images:\n      - "myuser/myimage"\n      - "gcr.io/myuser/myimage"\n\n    # Tag names.\n    #\n    # Empty tags are ignored.\n    #\n    # Templates: allowed.\n    tags:\n      - "v{{ .Version }}"\n      - "{{ if .IsNightly }}nightly{{ end }}"\n      - "{{ if not .IsNightly }}latest{{ end }}"\n\n    # If your Dockerfile copies files other than binaries and packages,\n    # you should list them here as well.\n    # Note that Kmdo will create the same structure inside a temporary\n    # directory, so if you add `foo/bar.json` here, on your Dockerfile you can\n    # `COPY foo/bar.json /whatever.json`.\n    # Also note that the paths here are relative to the directory in which\n    # Kmdo is being run (usually the repository root directory).\n    # This field does not support wildcards, you can add an entire directory here\n    # and use wildcards when you `COPY`/`ADD` in your Dockerfile.\n    extra_files:\n      - config.yml\n\n    # Labels to be added to the image.\n    #\n    # Items with empty keys or values will be ignored.\n    #\n    # Templates: allowed.\n    labels:\n      "org.opencontainers.image.description": "My software"\n      "org.opencontainers.image.created": "{{.Date}}"\n      "org.opencontainers.image.name": "{{.ProjectName}}"\n      "org.opencontainers.image.revision": "{{.FullCommit}}"\n      "org.opencontainers.image.version": "{{.Version}}"\n      "org.opencontainers.image.source": "{{.GitURL}}"\n\n    # Annotations to be added to the image.\n    #\n    # Items with empty keys or values will be ignored.\n    #\n    # Templates: allowed.\n    annotations:\n      "foo": "bar"\n      "project": "{{.ProjectName}}"\n\n    # Platforms to build.\n    #\n    # Default: [ linux/amd64 linux/arm64 ]\n    platforms:\n      - linux/amd64\n      - linux/arm64\n\n    # Whether to disable this particular Docker configuration.\n    #\n    # Templates: allowed.\n    disable: "{{ .IsSnapshot }}"\n\n    # Whether to create and attach a SBOM to the image.\n    #\n    # Default: \'true\'\n    # Templates: allowed.\n    sbom: "{{ not .IsNightly }}"\n\n    # Additional `--build-arg`s to be passed.\n    #\n    # Templates: allowed.\n    build_args:\n      FOO: bar\n\n    # Arbitrary flags to pass to the build command.\n    #\n    # Note: use this at your own risk.\n    # Note: flags must have the `=` sign between flag name and value.\n    #\n    # Templates: allowed.\n    flags:\n      - "--ulimit=10"\n\n    # Retry configuration.\n    retry:\n      # Attempts of retry.\n      #\n      # Default: 10.\n      attempts: 5\n\n      # Delay between retry attempts.\n      #\n      # Default: 10s.\n      delay: 5s\n\n      # Maximum delay between retry attempts.\n      #\n      # Default: 5m.\n      max_delay: 2m\n'})}),"\n",(0,o.jsxs)(n.admonition,{title:'"dockers_v2"',type:"warning",children:[(0,o.jsxs)(n.p,{children:["The ",(0,o.jsx)(n.code,{children:"dockers_v2"})," name is provisional."]}),(0,o.jsxs)(n.p,{children:["It will replace ",(0,o.jsx)(n.code,{children:"dockers"})," and ",(0,o.jsx)(n.code,{children:"docker_manifests"})," in Kmdo v3 (no ETA),\nand will then be simply ",(0,o.jsx)(n.code,{children:"dockers"}),"."]}),(0,o.jsx)(n.p,{children:"We are doing it this way to prevent breaking changes releases now, so we can\ntest this new version for a while, before launching v3."})]}),"\n",(0,o.jsx)(n.h2,{id:"testing-locally",children:"Testing locally"}),"\n",(0,o.jsxs)(n.p,{children:["Docker buildx won't allow us to build a manifest without pushing it.\nTo get around this, when we build with ",(0,o.jsx)(n.code,{children:"--snapshot"}),", Kmdo will not build\nthe manifest anymore, and will instead build separated images, adding a platform\nsuffix to each tag."]}),"\n",(0,o.jsx)(n.p,{children:"Let's see what this means in practice.\nAssume we have a configuration like this:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",metastring:'title=".kmdopkg.yaml"',children:'snapshot:\n  version_template: "{{ incpatch .Version }}"\ndockers_v2:\n  - images:\n      - user/repo\n    tags:\n      - "{{.Version}}"\n    platforms:\n      - linux/amd64\n      - linux/arm64\n'})}),"\n",(0,o.jsxs)(n.p,{children:["If we run ",(0,o.jsx)(n.code,{children:"kmdo pub release"}),", i.e., a production build, it'll build and\npublish ",(0,o.jsx)(n.code,{children:"user/repo:1.2.3"}),", for example."]}),"\n",(0,o.jsxs)(n.p,{children:["If we run ",(0,o.jsx)(n.code,{children:"kmdo pub release --snapshot"}),", it'll build two images instead:\n",(0,o.jsx)(n.code,{children:"user/repo:1.2.4-amd64"})," and ",(0,o.jsx)(n.code,{children:"user/repo:1.2.4-arm64"}),"."]}),"\n",(0,o.jsx)(n.p,{children:"This way you can verify that your Docker build and Docker image work as\nexpected."}),"\n",(0,o.jsx)(n.h2,{id:"how-it-works",children:"How it works"}),"\n",(0,o.jsxs)(n.p,{children:["You can declare multiple Docker images.\nThey will be matched against the binaries generated by your ",(0,o.jsx)(n.code,{children:"builds"})," section and\npackages generated by your ",(0,o.jsx)(n.code,{children:"nfpms"})," section."]}),"\n",(0,o.jsxs)(n.p,{children:["If you have only one item in the ",(0,o.jsx)(n.code,{children:"builds"})," list,\nthe configuration can be as easy as adding the\nname and tags of your images to your ",(0,o.jsx)(n.code,{children:".kmdopkg.yaml"})," file:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",metastring:'title=".kmdopkg.yaml"',children:"dockers_v2:\n  - images:\n      - user/repo\n"})}),"\n",(0,o.jsxs)(n.p,{children:["You also need to create a ",(0,o.jsx)(n.code,{children:"Dockerfile"})," in your project's root directory:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-dockerfile",metastring:'title="Dockerfile"',children:'FROM scratch\nARG TARGETPLATFORM\nENTRYPOINT ["/usr/bin/myprogram"]\nCOPY $TARGETPLATFORM/myprogram /usr/bin/\n'})}),"\n",(0,o.jsxs)(n.p,{children:["This configuration will build and push a Docker image named ",(0,o.jsx)(n.code,{children:"user/repo:tagname"}),"."]}),"\n",(0,o.jsx)(n.h3,{id:"the-docker-build-context",children:"The Docker build context"}),"\n",(0,o.jsxs)(n.p,{children:["Note that we are not building any binaries in the ",(0,o.jsx)(n.code,{children:"Dockerfile"}),", we are instead\nmerely copying the binary to a ",(0,o.jsx)(n.code,{children:"scratch"})," image and setting up the ",(0,o.jsx)(n.code,{children:"entrypoint"}),"."]}),"\n",(0,o.jsx)(n.p,{children:"The idea is that you reuse the previously built binaries instead of building\nthem again when creating the Docker image."}),"\n",(0,o.jsxs)(n.p,{children:["The build context itself is a temporary directory which contains the\nbinaries and packages for the each of the defined target platforms.\nYou can then ",(0,o.jsx)(n.code,{children:"COPY"})," them into your image (mind the use of ",(0,o.jsx)(n.code,{children:"$TARGETPLATFORM"}),"\nabove)."]}),"\n",(0,o.jsxs)(n.p,{children:["A corollary of it being a temporary directory is that\n",(0,o.jsx)(n.strong,{children:"the context does not contain the source files"}),".\nIf you need to add some other file that is in your source directory, you'll\nneed to add it to the ",(0,o.jsx)(n.code,{children:"extra_files"})," property, so it'll get copied into the\ncontext."]}),"\n",(0,o.jsx)(n.p,{children:"All that being said, your Docker build context will usually look like this:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-sh",children:"temp-context-dir\n\u251c\u2500\u2500 Dockerfile\n\u251c\u2500\u2500 linux/arm64/myprogram\n\u251c\u2500\u2500 linux/arm64/myprogram.rpm\n\u251c\u2500\u2500 linux/arm64/myprogram.apk\n\u251c\u2500\u2500 linux/arm64/myprogram.deb\n\u251c\u2500\u2500 linux/amd64/myprogram\n\u251c\u2500\u2500 linux/amd64/myprogram.rpm\n\u251c\u2500\u2500 linux/amd64/myprogram.apk\n\u2514\u2500\u2500 linux/amd64/myprogram.deb\n"})}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.code,{children:"myprogram"})," would actually be your binary name, and the Linux package names\nwould follow their respective configuration's names."]}),"\n",(0,o.jsx)(n.h2,{id:"setting-up-a-builder",children:"Setting up a builder"}),"\n",(0,o.jsx)(n.p,{children:"For buildx to work, you'll need to have a builder that supports multi-platform\nbuilds set up."}),"\n",(0,o.jsx)(n.p,{children:"On Linux, you can do it with:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-sh",children:"docker buildx create --name=kumose --use\ndocker run --privileged --rm tonistiigi/binfmt --install all\n"})}),"\n",(0,o.jsx)(n.p,{children:"For what it's worth, this feature was built and tested with buildx v0.24.0."})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(c,{...e})}):c(e)}},8453:(e,n,i)=>{i.d(n,{R:()=>a,x:()=>s});var t=i(6540);const o={},r=t.createContext(o);function a(e){const n=t.useContext(r);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),t.createElement(r.Provider,{value:n},e.children)}}}]);