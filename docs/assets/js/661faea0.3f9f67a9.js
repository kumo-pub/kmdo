"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[9659],{7560:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>c,frontMatter:()=>a,metadata:()=>o,toc:()=>d});const o=JSON.parse('{"id":"tutorial/pub/publish/nix","title":"Nix User Repositories","description":"After releasing to GitHub, GitLab, or Gitea, Kmdo can generate and publish","source":"@site/docs/tutorial/pub/publish/nix.mdx","sourceDirName":"tutorial/pub/publish","slug":"/tutorial/pub/publish/nix","permalink":"/kmdo/docs/tutorial/pub/publish/nix","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Closing Milestones","permalink":"/kmdo/docs/tutorial/pub/publish/milestone"},"next":{"title":"Custom Publishers","permalink":"/kmdo/docs/tutorial/pub/publish/publishers"}}');var i=t(4848),s=t(8453);const a={},r="Nix User Repositories",l={},d=[{value:"Things not supported",id:"things-not-supported",level:2},{value:"Dependencies",id:"dependencies",level:2},{value:"<code>nix-hash</code>",id:"nix-hash",level:3},{value:"Setting up a NUR",id:"setting-up-a-nur",level:2},{value:"Pull Requests",id:"pull-requests",level:2},{value:"Templates",id:"templates",level:3},{value:"Cross-repository pull requests",id:"cross-repository-pull-requests",level:3},{value:"Things that don&#39;t work",id:"things-that-dont-work",level:3}];function h(e){const n={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",section:"section",sup:"sup",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"nix-user-repositories",children:"Nix User Repositories"})}),"\n",(0,i.jsxs)(n.p,{children:["After releasing to GitHub, GitLab, or Gitea, Kmdo can generate and publish\na ",(0,i.jsx)(n.em,{children:"nix derivation"})," to an existing ",(0,i.jsx)(n.a,{href:"https://github.com/nix-community/NUR",children:"Nix User Repository"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"nix"})," section specifies how the pkgs should be created:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",metastring:'title=".kmdopkg.yaml"',children:"nix:\n  - #\n    # Name of the recipe\n    #\n    # Default: the project name.\n    # Templates: allowed.\n    name: myproject\n\n    # IDs of the archives to use.\n    # Empty means all IDs.\n    ids:\n      - foo\n      - bar\n\n    # GOAMD64 to specify which amd64 version to use if there are multiple\n    # versions from the build section.\n    #\n    # Default: v1.\n    goamd64: v1\n\n    # URL which is determined by the given Token (github, gitlab or gitea).\n    #\n    # Default depends on the client.\n    # Templates: allowed.\n    url_template: \"https://github.mycompany.com/foo/bar/releases/download/{{ .Tag }}/{{ .ArtifactName }}\"\n\n    # The project name and current git tag are used in the format string.\n    #\n    # Templates: allowed.\n    commit_msg_template: \"{{ .ProjectName }}: {{ .Tag }}\"\n\n    # Path for the file inside the repository.\n    #\n    # Default: pkgs/<name>/default.nix.\n    # Templates: allowed.\n    path: pkgs/foo.nix\n\n    # Your app's homepage.\n    #\n    # Templates: allowed.\n    # Default: inferred from global metadata.\n    homepage: \"https://example.com/\"\n\n    # Your app's description.\n    #\n    # Templates: allowed.\n    # Default: inferred from global metadata.\n    description: \"Software to create fast and easy drum rolls.\"\n\n    # License name.\n    #\n    # Default: inferred from global metadata.\n    license: \"mit\"\n\n    # Setting this will prevent kmdo to actually try to commit the updated\n    # package - instead, it will be stored on the dist directory only,\n    # leaving the responsibility of publishing it to the user.\n    #\n    # If set to auto, the release will not be uploaded to the repository\n    # in case there is an indicator for prerelease in the tag e.g. v1.0.0-rc1\n    #\n    # Templates: allowed.\n    skip_upload: true\n\n    # Runtime dependencies of the package.\n    dependencies:\n    - zsh\n    - chromium\n    - name: bash\n      os: linux\n    - name: fish\n      os: darwin\n\n    # Custom install script.\n    #\n    # Default: 'mkdir -p $out/bin; cp -vr $binary $out/bin/$binary', and\n    #   `makeWrapper` if `dependencies` were provided.\n    # Templates: allowed.\n    install: |\n      mkdir -p $out/bin\n      cp -vr ./foo $out/bin/foo\n\n    # Custom additional install instructions.\n    # This has the advantage of preventing you to rewrite the `install` script\n    # if the defaults work for you.\n    #\n    # Templates: allowed.\n    extra_install: |\n      installManPage ./manpages/foo.1.gz\n\n    # Custom post_install script.\n    # Could be used to do any additional work after the \"install\" script\n    #\n    # Templates: allowed.\n    post_install: |\n      installShellCompletion ./completions/*\n\n    # Repository to push the generated files to.\n    repository:\n      # Repository owner.\n      #\n      # Templates: allowed.\n      owner: caarlos0\n\n      # Repository name.\n      #\n      # Templates: allowed.\n      name: my-repo\n\n      # Optionally a branch can be provided.\n      #\n      # Default: default repository branch.\n      # Templates: allowed.\n      branch: main\n\n      # Optionally a token can be provided, if it differs from the token\n      # provided to Kmdo\n      #\n      # Templates: allowed.\n      token: \"{{ .Env.GITHUB_PERSONAL_AUTH_TOKEN }}\"\n\n\n      # Sets up pull request creation instead of just pushing to the given branch.\n      # Make sure the 'branch' property is different from base before enabling\n      # it.\n      #\n      # This might require a personal access token.\n      pull_request:\n        # Whether to enable it or not.\n        enabled: true\n\n        # Whether to open the PR as a draft or not.\n        draft: true\n\n        # Allows to set a body for the pull request.\n        # If the repository has a pull request template, it will be appended to\n        # this.\n        body: |\n          cc/ @foobar\n\n        # Base can also be another repository, in which case the owner and name\n        # above will be used as HEAD, allowing cross-repository pull requests.\n        base:\n          owner: kumose\n          name: my-repo\n          branch: main\n\n      # Clone, create the file, commit and push, to a regular Git repository.\n      #\n      # Notice that this will only have any effect if the given URL is not\n      # empty.\n      git:\n        # The Git URL to push.\n        #\n        # Templates: allowed.\n        url: 'ssh://git@myserver.com:repo.git'\n\n        # The SSH private key that should be used to commit to the Git\n        # repository.\n        # This can either be a path or the key contents.\n        #\n        # IMPORTANT: the key must not be password-protected.\n        #\n        # WARNING: do not expose your private key in the configuration file!\n        #\n        # Templates: allowed.\n        private_key: '{{ .Env.PRIVATE_KEY_PATH }}'\n\n        # The value to be passed to `GIT_SSH_COMMAND`.\n        # This is mainly used to specify the SSH private key used to pull/push\n        # to the Git URL.\n        #\n        # Default: 'ssh -i {{ .KeyPath }} -o StrictHostKeyChecking=accept-new -F /dev/null'.\n        # Templates: allowed.\n        ssh_command: 'ssh -i {{ .Env.KEY }} -o SomeOption=yes'\n\n    # Git author used to commit to the repository.\n    #\n    # Default: inferred from global metadata.\n    commit_author:\n      # Git author name.\n      #\n      # Templates: allowed.\n      name: kumosebot\n\n      # Git author email.\n      #\n      # Templates: allowed.\n      email: bot@kumose.cc\n\n      # Git commit signing configuration.\n      # Only useful if repository is of type 'git'.\n      signing:\n        # Enable commit signing.\n        enabled: true\n\n        # The signing key to use.\n        # Can be a key ID, fingerprint, email address, or path to a key file.\n        #\n        # Templates: allowed.\n        key: \"{{ .Env.GPG_SIGNING_KEY }}\"\n\n        # The GPG program to use for signing.\n        #\n        # Templates: allowed.\n        program: gpg2\n\n        # The signature format to use.\n        #\n        # Valid options: openpgp, x509, ssh.\n        # Default: openpgp.\n        format: openpgp\n\n"})}),"\n",(0,i.jsx)(n.h2,{id:"things-not-supported",children:"Things not supported"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Generating packages that compile from source (using ",(0,i.jsx)(n.code,{children:"buildGoModule"}),")"]}),"\n",(0,i.jsxs)(n.li,{children:["Generating packages when ",(0,i.jsx)(n.code,{children:"archives.format"})," is ",(0,i.jsx)(n.code,{children:"binary"})]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"dependencies",children:"Dependencies"}),"\n",(0,i.jsx)(n.h3,{id:"nix-hash",children:(0,i.jsx)(n.code,{children:"nix-hash"})}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"nix-hash"})," binary must be available in the ",(0,i.jsx)(n.code,{children:"$PATH"})," for the\npublishing to work."]}),"\n",(0,i.jsx)(n.h2,{id:"setting-up-a-nur",children:"Setting up a NUR"}),"\n",(0,i.jsxs)(n.p,{children:["To set up a Nix User Repository, follow the instructions in their\n",(0,i.jsx)(n.a,{href:"https://github.com/nix-community/NUR",children:"repository"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"Then, you'll need to:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["publish a release with Kmdo: it should create the package at\n",(0,i.jsx)(n.code,{children:"./pkgs/{name}/default.nix"})," or whatever path you set it up to"]}),"\n",(0,i.jsxs)(n.li,{children:["make sure ",(0,i.jsx)(n.code,{children:"./flake.nix"})," is correct with what you want, especially the\n",(0,i.jsx)(n.code,{children:"systems"})," bit"]}),"\n",(0,i.jsxs)(n.li,{children:["add your package to ",(0,i.jsx)(n.code,{children:"./default.nix"})]}),"\n",(0,i.jsxs)(n.li,{children:["edit your ",(0,i.jsx)(n.code,{children:"README.md"})," removing the template stuff"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"That's it!"}),"\n",(0,i.jsx)(n.h2,{id:"pull-requests",children:"Pull Requests"}),"\n",(0,i.jsx)(n.p,{children:"Kmdo allows you to, instead of pushing directly to the main branch, push\nto a feature branch, and open a pull requests with the changes."}),"\n",(0,i.jsx)(n.h3,{id:"templates",children:"Templates"}),"\n",(0,i.jsxs)(n.p,{children:["Kmdo will check for a ",(0,i.jsx)(n.code,{children:".github/PULL_REQUEST_TEMPLATE.md"}),", and set it in\nthe pull request body if it exists."]}),"\n",(0,i.jsxs)(n.p,{children:["We do that to prevent extra work for maintainers of things like ",(0,i.jsx)(n.code,{children:"winget-pkgs"}),",\n",(0,i.jsx)(n.code,{children:"nixpkgs"}),", and so on."]}),"\n",(0,i.jsx)(n.h3,{id:"cross-repository-pull-requests",children:"Cross-repository pull requests"}),"\n",(0,i.jsx)(n.p,{children:"You can also push to a fork, and open the pull request in the original branch."}),"\n",(0,i.jsx)(n.p,{children:"Here's an example on how to set it up:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",metastring:'title=".kmdopkg.yaml"',children:'# ...\nsomething: # can be nix, brews, etc...\n  - repository:\n      owner: john\n      name: repo\n      branch: "{{.ProjectName}}-{{.Version}}"\n      pull_request:\n        enabled: true\n        base:\n          owner: mike\n          name: repo\n          branch: main\n'})}),"\n",(0,i.jsx)(n.p,{children:"This will:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Try to sync the ",(0,i.jsx)(n.code,{children:"john/repo"})," fork with ",(0,i.jsx)(n.code,{children:"mike/repo:main"})," (if on GitHub)."]}),"\n",(0,i.jsxs)(n.li,{children:["Create the files into ",(0,i.jsx)(n.code,{children:"john/repo"}),", in the branch ",(0,i.jsx)(n.code,{children:"foo-1.2.3"})," (assuming\n",(0,i.jsx)(n.code,{children:"ProjectName=foo"})," and ",(0,i.jsx)(n.code,{children:"Version=1.2.3"}),"). ",(0,i.jsx)(n.sup,{children:(0,i.jsx)(n.a,{href:"#user-content-fn-head",id:"user-content-fnref-head","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"1"})})]}),"\n",(0,i.jsxs)(n.li,{children:["Open a pull request from ",(0,i.jsx)(n.code,{children:"john/repo"})," into ",(0,i.jsx)(n.code,{children:"mike/repo"}),", with the branch ",(0,i.jsx)(n.code,{children:"main"}),"\nas target. ",(0,i.jsx)(n.sup,{children:(0,i.jsx)(n.a,{href:"#user-content-fn-base",id:"user-content-fnref-base","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"2"})})]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"things-that-dont-work",children:"Things that don't work"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Opening pull requests to a forked repository (",(0,i.jsx)(n.code,{children:"go-github"})," does not have the\nrequired fields to do it)."]}),"\n",(0,i.jsx)(n.li,{children:"Since this can fail for a myriad of reasons, if an error happen, it'll log it\nto the release output, but will not fail the pipeline."}),"\n"]}),"\n","\n",(0,i.jsxs)(n.section,{"data-footnotes":!0,className:"footnotes",children:[(0,i.jsx)(n.h2,{className:"sr-only",id:"footnote-label",children:"Footnotes"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{id:"user-content-fn-head",children:["\n",(0,i.jsxs)(n.p,{children:["In GitHub's terms, this means ",(0,i.jsx)(n.code,{children:"head=john:repo:foo-1.2.3"})," ",(0,i.jsx)(n.a,{href:"#user-content-fnref-head","data-footnote-backref":"","aria-label":"Back to reference 1",className:"data-footnote-backref",children:"\u21a9"})]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{id:"user-content-fn-base",children:["\n",(0,i.jsxs)(n.p,{children:["In GitHub's terms, this means ",(0,i.jsx)(n.code,{children:"base=mike:repo:main"})," ",(0,i.jsx)(n.a,{href:"#user-content-fnref-base","data-footnote-backref":"","aria-label":"Back to reference 2",className:"data-footnote-backref",children:"\u21a9"})]}),"\n"]}),"\n"]}),"\n"]})]})}function c(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(h,{...e})}):h(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>r});var o=t(6540);const i={},s=o.createContext(i);function a(e){const n=o.useContext(s);return o.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),o.createElement(s.Provider,{value:n},e.children)}}}]);