"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[3192],{1300:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>a,contentTitle:()=>o,default:()=>d,frontMatter:()=>r,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"tutorial/pub/publish/publishers","title":"Custom Publishers","description":"Kmdo supports publishing artifacts by executing a custom publisher.","source":"@site/docs/tutorial/pub/publish/publishers.mdx","sourceDirName":"tutorial/pub/publish","slug":"/tutorial/pub/publish/publishers","permalink":"/docs/tutorial/pub/publish/publishers","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Nix User Repositories","permalink":"/docs/tutorial/pub/publish/nix"},"next":{"title":"Release","permalink":"/docs/tutorial/pub/publish/release"}}');var t=i(4848),l=i(8453);const r={},o="Custom Publishers",a={},c=[{value:"How it works",id:"how-it-works",level:2},{value:"Environment",id:"environment",level:3},{value:"Variables",id:"variables",level:3},{value:"Customization",id:"customization",level:2}];function h(e){const n={admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,l.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"custom-publishers",children:"Custom Publishers"})}),"\n",(0,t.jsx)(n.p,{children:"Kmdo supports publishing artifacts by executing a custom publisher."}),"\n",(0,t.jsx)(n.h2,{id:"how-it-works",children:"How it works"}),"\n",(0,t.jsxs)(n.p,{children:["You can declare multiple ",(0,t.jsx)(n.code,{children:"publishers"})," instances. Each publisher will be\nexecuted for each (filtered) artifact. For example, there will be a total of\n6 executions for 2 publishers with 3 artifacts."]}),"\n",(0,t.jsx)(n.p,{children:"Publishers run sequentially in the order they're defined\nand executions are parallelized between all artifacts.\nIn other words the publisher is expected to be safe to run\nin multiple instances in parallel."}),"\n",(0,t.jsxs)(n.p,{children:["If you have only one ",(0,t.jsx)(n.code,{children:"publishers"})," instance, the configuration is as easy as\nadding the command to your ",(0,t.jsx)(n.code,{children:".kmdopkg.yaml"})," file:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"publishers:\n  - name: my-publisher\n    cmd: custom-publisher -version={{ .Version }} {{ abs .ArtifactPath }}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"environment",children:"Environment"}),"\n",(0,t.jsx)(n.p,{children:"Commands, which are executed as custom publishers only inherit a subset of\nthe system environment variables (unlike existing hooks) as a precaution to\navoid leaking sensitive data accidentally and provide better control of the\nenvironment for each individual process where variable names may overlap\nunintentionally."}),"\n",(0,t.jsx)(n.p,{children:"Environment variables that are kept:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"HOME"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"USER"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"USERPROFILE"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"TMPDIR"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"TMP"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"TEMP"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"PATH"})}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["You can however use ",(0,t.jsx)(n.code,{children:".Env.NAME"})," templating syntax, which enables\nmore explicit inheritance."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"- cmd: custom-publisher\n  env:\n    - SECRET_TOKEN={{ .Env.SECRET_TOKEN }}\n"})}),"\n",(0,t.jsx)(n.p,{children:"The publisher explicit environment variables take precedence over the\ninherited set of variables as well."}),"\n",(0,t.jsx)(n.h3,{id:"variables",children:"Variables"}),"\n",(0,t.jsxs)(n.p,{children:["Command (",(0,t.jsx)(n.code,{children:"cmd"}),"), workdir (",(0,t.jsx)(n.code,{children:"dir"}),") and environment variables (",(0,t.jsx)(n.code,{children:"env"}),") support\ntemplates:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'publishers:\n  - name: production\n    cmd: |\n      custom-publisher \\\n      -product={{ .ProjectName }} \\\n      -version={{ .Version }} \\\n      {{ .ArtifactName }}\n    dir: "{{ dir .ArtifactPath }}"\n    env:\n      - TOKEN={{ .Env.CUSTOM_PUBLISHER_TOKEN }}\n'})}),"\n",(0,t.jsx)(n.p,{children:"So the above example will execute:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"custom-publisher -product=kumose -version=1.0.0 kmdo_1.0.0_linux_amd64.zip\n"})}),"\n",(0,t.jsxs)(n.p,{children:["In ",(0,t.jsx)(n.code,{children:"/path/to/dist"})," with ",(0,t.jsx)(n.code,{children:"TOKEN=token"}),", assuming that Kmdo is executed\nwith ",(0,t.jsx)(n.code,{children:"CUSTOM_PUBLISHER_TOKEN=token"}),"."]}),"\n",(0,t.jsx)(n.p,{children:"Supported variables:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"Version"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"Tag"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"ProjectName"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"ArtifactName"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"ArtifactPath"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"Os"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"Arch"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"Arm"})}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"customization",children:"Customization"}),"\n",(0,t.jsx)(n.p,{children:"Of course, you can customize a lot of things:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",metastring:'title=".kmdopkg.yaml"',children:'publishers:\n  - #\n    # Unique name of your publisher. Used for identification\n    name: "custom"\n\n    # IDs of the artifacts you want to publish\n    ids:\n      - foo\n      - bar\n\n\n    # Publish checksums.\n    checksum: true\n\n    # Upload metadata.json and artifacts.json.\n    meta: true\n\n    # Publish signatures.\n    signature: true\n\n    # Working directory in which to execute the command\n    dir: "/utils"\n\n    # Command to be executed\n    cmd: custom-publisher -product={{ .ProjectName }} -version={{ .Version }} {{ .ArtifactPath }}\n\n    # Environment variables\n    env:\n      - API_TOKEN=secret-token\n\n    # Whether to disable this particular upload configuration.\n    #\n    # Templates: allowed.\n    disable: "{{ if .IsNightly }}true{{ end }}"\n\n    # You can publish extra pre-existing files.\n    # The filename published will be the last part of the path (base).\n    # If another file with the same name exists, the last one found will be used.\n    #\n    # Templates: allowed.\n    extra_files:\n      - glob: ./path/to/file.txt\n      - glob: ./glob/**/to/**/file/**/*\n      - glob: ./glob/foo/to/bar/file/foobar/override_from_previous\n      - glob: ./single_file.txt\n        name_template: file.txt # note that this only works if glob matches 1 file only\n\n\n    # This allows you to use the output of your custom publisher in templates\n    # later, for instance, in the release notes.\n    #\n    # The example bellow can be used with \'{{ index .Outputs "foo.deb" }}\'\n    # (assuming artifact name is \'foo.deb\').\n    #\n    # Templates: allowed.\n    output: "check-{{ .ArtifactName }}"\n'})}),"\n",(0,t.jsx)(n.admonition,{type:"warning",children:(0,t.jsx)(n.p,{children:"This will run as the last step of the publishing phase."})}),"\n",(0,t.jsx)(n.p,{children:"These settings should allow you to push your artifacts to any number of\nendpoints, which may require non-trivial authentication or has otherwise complex\nrequirements."})]})}function d(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(h,{...e})}):h(e)}},8453:(e,n,i)=>{i.d(n,{R:()=>r,x:()=>o});var s=i(6540);const t={},l=s.createContext(t);function r(e){const n=s.useContext(l);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:r(e.components),s.createElement(l.Provider,{value:n},e.children)}}}]);