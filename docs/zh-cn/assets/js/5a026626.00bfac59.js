"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[2799],{1059:(e,n,o)=>{o.r(n),o.d(n,{assets:()=>d,contentTitle:()=>t,default:()=>u,frontMatter:()=>r,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"cookbook/build-go-modules","title":"Building Go modules","description":"With the default configs, you can already build a Go module without issues.","source":"@site/docs/cookbook/build-go-modules.mdx","sourceDirName":"cookbook","slug":"/cookbook/build-go-modules","permalink":"/kmdo/zh-cn/docs/cookbook/build-go-modules","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"cookBookSidebar","next":{"title":"Builds: using complex template environment variables","permalink":"/kmdo/zh-cn/docs/cookbook/builds-complex-envs"}}');var s=o(4848),l=o(8453);const r={},t="Building Go modules",d={},c=[{value:"Getting the version from the module",id:"getting-the-version-from-the-module",level:2},{value:"Limitations",id:"limitations",level:2},{value:"More information",id:"more-information",level:2}];function a(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,l.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"building-go-modules",children:"Building Go modules"})}),"\n",(0,s.jsx)(n.p,{children:"With the default configs, you can already build a Go module without issues."}),"\n",(0,s.jsxs)(n.p,{children:["But, if you want to access module information in runtime (e.g. ",(0,s.jsx)(n.code,{children:"debug.BuildInfo"})," or ",(0,s.jsx)(n.code,{children:"go version -m $binary"}),'), you\'ll\nneed to setup Kmdo to "proxy" that module before building it.']}),"\n",(0,s.jsx)(n.p,{children:"To do that, you can simply add this to your config:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",metastring:'title=".kmdopkg.yaml"',children:"gomod:\n  proxy: true\n"})}),"\n",(0,s.jsx)(n.p,{children:"In practice, what this does is:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["for each of your builds, create a ",(0,s.jsx)(n.code,{children:"dist/proxy/{{ build.id }}"}),";"]}),"\n",(0,s.jsxs)(n.li,{children:["creates a ",(0,s.jsx)(n.code,{children:"go.mod"})," that requires your ",(0,s.jsx)(n.strong,{children:"main module"})," at the ",(0,s.jsx)(n.strong,{children:"current tag"}),";"]}),"\n",(0,s.jsxs)(n.li,{children:["copy the project's ",(0,s.jsx)(n.code,{children:"go.sum"})," to that directory."]}),"\n",(0,s.jsxs)(n.li,{children:["runs ",(0,s.jsx)(n.code,{children:"go get module@version"})]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"In which:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"build.id"}),": the ",(0,s.jsx)(n.code,{children:"id"})," property in your ",(0,s.jsx)(n.code,{children:"build"})," definition;"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"main module"}),": is the output of ",(0,s.jsx)(n.code,{children:"go list -m"}),";"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"main package"}),": is the ",(0,s.jsx)(n.strong,{children:"main module"})," + your build's ",(0,s.jsx)(n.code,{children:"main"}),";"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"current tag"}),": is the tag that is being built."]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"So, let's say:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"main module"}),": ",(0,s.jsx)(n.code,{children:"github.com/kumose-go/nfpm"}),";"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"build id"}),": ",(0,s.jsx)(n.code,{children:"nfpm"})]}),"\n",(0,s.jsxs)(n.li,{children:["build's ",(0,s.jsx)(n.code,{children:"main"}),": ",(0,s.jsx)(n.code,{children:"./cmd/nfpm/"}),";"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"current tag"}),": ",(0,s.jsx)(n.code,{children:"v2.5.0"}),"."]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Kmdo will create a ",(0,s.jsx)(n.code,{children:"go.mod"})," like:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-gomod",children:"module nfpm\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Then it'll copy the ",(0,s.jsx)(n.code,{children:"go.sum"})," into this directory, and run:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"go get github.com/kumose-go/nfpm@v2.5.0\n"})}),"\n",(0,s.jsx)(n.p,{children:"And, to build, it will use something like:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"go build -o nfpm github.com/kumose-go/nfpm/cmd/nfpm\n"})}),"\n",(0,s.jsxs)(n.p,{children:["This will resolve the source code from the defined module proxy using ",(0,s.jsx)(n.code,{children:"proxy.golang.org"}),".\nYour project's ",(0,s.jsx)(n.code,{children:"go.sum"})," will be used to verify any modules that are downloaded, with ",(0,s.jsx)(n.code,{children:"sum.golang.org"}),' "filling in" any gaps.']}),"\n",(0,s.jsx)(n.h2,{id:"getting-the-version-from-the-module",children:"Getting the version from the module"}),"\n",(0,s.jsxs)(n.p,{children:["You can also get the module version at runtime using ",(0,s.jsx)(n.a,{href:"https://pkg.go.dev/runtime/debug#ReadBuildInfo",children:(0,s.jsx)(n.code,{children:"debug#ReadBuildInfo"})}),".\nIt is useful to display the version of your program to the user, for example."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-golang",children:'package main\n\nimport (\n\t"fmt"\n\t"runtime/debug"\n)\n\nfunc main() {\n  if info, ok := debug.ReadBuildInfo(); ok && info.Main.Sum != "" {\n    fmt.Println(info)\n  }\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:["You can also use ",(0,s.jsx)(n.code,{children:"go version -m my_program"})," to display the go module information."]}),"\n",(0,s.jsx)(n.h2,{id:"limitations",children:"Limitations"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Extra files will still be copied from the current project's root directory and not from the proxy cache;"}),"\n",(0,s.jsx)(n.li,{children:"You can't build packages that are not contained in the main module;"}),"\n",(0,s.jsx)(n.li,{children:"VCS info will not be available."}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"more-information",children:"More information"}),"\n",(0,s.jsxs)(n.p,{children:["You can find more information about it on the ",(0,s.jsx)(n.a,{href:"https://github.com/kumose/kmdo/issues/1354",children:"issue"})," that originated it and its subsequent ",(0,s.jsx)(n.a,{href:"https://github.com/kumose/kmdo/pull/2129",children:"pull request"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["Make sure to also read the ",(0,s.jsx)(n.a,{href:"/kmdo/zh-cn/docs/tutorial/pub/builds/verifiable_builds",children:"relevant documentation"})," for more options."]})]})}function u(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(a,{...e})}):a(e)}},8453:(e,n,o)=>{o.d(n,{R:()=>r,x:()=>t});var i=o(6540);const s={},l=i.createContext(s);function r(e){const n=i.useContext(l);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),i.createElement(l.Provider,{value:n},e.children)}}}]);