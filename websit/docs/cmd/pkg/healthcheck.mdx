---
slug: /cmd/pkg/healthcheck
---
# kmdo pkg healthcheck 命令文档
## 概述
kmdo pkg healthcheck 命令用于检查项目构建/运行所需的工具是否已安装并配置在系统 $PATH 中，支持静默模式和自定义配置文件，若缺失任一必需工具则返回非零退出码，帮助提前排查环境依赖问题，避免后续操作失败。

## 命令结构
```shell
kmdo pkg healthcheck [FLAGS]
kmdo pkg hc [FLAGS]  # 简写形式
```

## 核心功能
1. 自动识别依赖工具：根据配置文件和项目类型，识别构建/运行所需的所有工具（如 go、rustc、zig 等）。
2. 双重校验逻辑：先检查工具是否在 $PATH 中，再（对带参数的工具）执行命令验证可用性。
3. 避免重复校验：通过同步映射缓存已检查工具，确保同一工具仅校验一次，提升效率。
4. 静默模式支持：无输出仅返回退出码，适配自动化脚本场景。
5. 清晰状态输出：通过图标区分工具“存在且可用”（✓）和“缺失/不可用”（⚠）。

## 命令 Flags 说明
| Flag | 简写 | 类型 | 默认值 | 描述 |
|------|------|------|--------|------|
| --config | -f | 字符串 | "" | 自定义配置文件路径（支持 yaml/yml 格式，默认按优先级查找项目内配置文件） |
| --quiet | -q | 布尔值 | false | 静默模式：不输出任何日志，仅通过退出码表示检查结果 |
| --deprecated | - | 布尔值 | false | 废弃标志（默认隐藏，无实际功能） |

## 校验逻辑说明
### 1. 工具识别来源
- 配置文件：通过 `--config` 指定的文件或默认查找的 .kmdopkg.yaml 中定义的依赖工具。
- 项目类型：结合项目语言（如 Go、Rust）自动关联的必需工具（如 go 对应 Go 项目，cargo 对应 Rust 项目）。

### 2. 校验步骤
#### 步骤1：检查工具是否在 $PATH 中
- 调用 `exec.LookPath` 验证工具可执行文件是否存在于系统环境变量 $PATH 中。
- 若不存在，输出警告日志并记录错误。

#### 步骤2：带参数的工具额外验证
- 若工具需带参数（如 `python --version`），执行 `exec.CommandContext` 运行完整命令。
- 若命令执行失败（如参数无效、工具损坏），输出警告日志并记录错误。

### 3. 重复校验防护
- 使用 `sync.Map` 缓存已检查的工具，避免同一工具被多次校验（如多项目依赖同一工具时）。

## 输出说明
### 正常输出（所有工具可用）
ℹ️  checking tools...
✓ go
✓ git
✓ cargo
✅ done!

### 异常输出（存在缺失工具）
ℹ️  checking tools...
✓ go
⚠ rustc - not present in path
✓ git
❌ one or more needed tools are not present

### 带参数工具校验输出（示例）
ℹ️  checking tools...
✓ python --version
✓ zig build --help
⚠ bun --version - command failed
❌ one or more needed tools are not present

## 退出码说明
| 退出码 | 含义 |
|--------|------|
| 0 | 所有必需工具均已安装并可用 |
| 1 | 至少一个必需工具缺失或不可用 |

## 详细使用场景与说明
### 场景1：默认检查（项目内配置）
#### 用法
kmdo pkg healthcheck
# 或简写
kmdo pkg hc
#### 适用场景
本地开发前检查环境依赖，快速确认工具是否齐全。

### 场景2：自定义配置文件检查
#### 用法
kmdo pkg healthcheck --config ./custom-config.yaml
#### 适用场景
项目配置文件不在默认路径，或需检查非标准依赖工具时。

### 场景3：静默模式（自动化脚本）
#### 用法
kmdo pkg healthcheck --quiet
#### 适用场景
CI/CD 流水线、Makefile 等自动化脚本中，仅需通过退出码判断环境是否合规。
#### 脚本示例
#!/bin/bash
if ! kmdo pkg hc -q; then
  echo "错误：缺少必需工具，请检查环境配置"
  exit 1
fi
echo "环境检查通过，开始构建..."

## 注意事项
1. 配置文件优先级：`--config` 指定的文件优先级高于默认查找的配置文件，若指定则忽略默认路径。
2. 工具参数支持：支持带参数的工具校验（如 `python --version`），仅当完整命令执行成功时判定为可用。
3. 缓存机制：同一命令执行过程中，同一工具（含参数）仅校验一次，跨命令不缓存。
4. 权限说明：部分工具校验可能需要执行权限，确保当前用户有足够权限运行目标工具。
5. 退出码含义：仅当所有工具均可用时返回 0，任一工具缺失/不可用均返回 1，便于脚本判断结果。