---
slug: /cmd/pkg/build
---
# kmdo pkg build 命令文档
## 概述
kmdo pkg build 命令用于构建当前项目的二进制文件，类比 `go build` 但更聚焦于统一配置管理，支持多目标构建、快照版本生成、指定构建ID等功能。核心价值是将构建规则（如 ldflags）集中到 kmdo 配置文件，避免多场景重复配置，同时适配本地快速构建与自动化流水线需求。

## 命令结构
kmdo pkg build [FLAGS]
kmdo pkg b [FLAGS]  # 简写形式

## 核心功能
1. 按配置文件定义的规则构建二进制文件，支持多目标（多OS/架构）构建。
2. 生成快照版本（无版本号，跳过校验）或自动根据Git仓库状态触发快照构建。
3. 支持本地快速构建（仅当前机器OS/架构）和指定ID的精准构建。
4. 构建前自动清理输出目录，支持并发构建优化速度。
5. 构建后可指定路径复制二进制文件（单目标+单构建ID场景）。

## 命令 Flags 说明
| Flag | 简写 | 类型 | 默认值 | 描述 |
|------|------|------|--------|------|
| --config | -f | 字符串 | "" | 加载配置文件路径（支持 yaml/yml 格式，默认读取项目内 .kmdopkg.yaml） |
| --snapshot | - | 布尔值 | false | 生成无版本号的快照构建，跳过所有校验 |
| --auto-snapshot | - | 布尔值 | false | Git仓库有未提交变更时，自动触发 --snapshot 模式 |
| --clean | - | 布尔值 | false | 构建前删除 dist 目录（清理旧构建产物） |
| --parallelism | -p | 整数 | 0 | 并发构建任务数（默认等于CPU核心数） |
| --timeout | - | 时长 | 1小时 | 整个构建过程的超时时间（如 30m 表示30分钟） |
| --single-target | - | 布尔值 | false | 仅构建当前机器的OS/架构（优先级：环境变量 > 系统默认） |
| --id | - | 字符串数组 | [] | 仅构建指定ID的构建任务（配置文件中定义的 Builds.ID） |
| --output | -o | 字符串 | "" | 构建后复制二进制文件到指定路径（仅支持 --single-target + 单构建ID场景） |
| --skip | - | 字符串切片 | [] | 跳过指定构建步骤（有效值参考 skips.Build 定义） |
| --deprecated | - | 布尔值 | false | 强制打印废弃提示（仅测试用，默认隐藏） |

## 关键环境变量（--single-target 模式）
使用 --single-target 时，可通过以下环境变量指定构建目标（未指定则使用当前机器配置）：
- TARGET：完整目标标识（如 linux-amd64）
- GOOS：目标操作系统（如 linux、darwin、windows）
- GOARCH：目标架构（如 amd64、arm64、riscv64）
- GOARM：ARM架构版本（如 7）
- GOAMD64：AMD64架构细分版本（如 v3）
- 其他：GOARM64、GORISCV64、GO386、GOPPC64、GOMIPS

## 详细使用场景与说明
### 场景1：默认构建（按配置文件多目标构建）
#### 功能
加载项目内 .kmdopkg.yaml 配置，构建所有定义的目标（多OS/架构），输出产物到 dist 目录。
#### 用法
kmdo pkg build
#### 示例输出
ℹ️  loading configuration from .kmdopkg.yaml
ℹ️  parallelism: 8
ℹ️  starting build pipeline
✅ build succeeded after 1m20s

### 场景2：本地快速构建（仅当前机器目标）
#### 功能
仅构建当前OS/架构的二进制文件，适用于本地测试，速度更快。
#### 用法

```shell
kmdo pkg build --single-target
# 或指定输出路径
kmdo pkg build --single-target -o ./myapp

#### 示例（指定目标架构）
# 构建 linux-amd64 目标（当前机器为其他架构时）
GOOS=linux GOARCH=amd64 kmdo pkg build --single-target

### 场景3：指定构建ID（多构建任务中选指定项）
```

#### 功能
配置文件中定义多个 Builds 时，仅构建指定ID的任务（如区分不同二进制产物）。
#### 用法

```shell
kmdo pkg build --id <build-id-1> --id <build-id-2>
#### 示例
# 仅构建ID为 "cli" 和 "agent" 的任务
kmdo pkg build --id cli --id agent

### 场景4：快照构建（跳过校验，无版本号）
#### 功能
生成无版本号的快照产物，跳过版本校验等步骤，适用于开发测试。
#### 用法
# 手动触发快照构建
kmdo pkg build --snapshot

# Git仓库有未提交变更时自动触发快照
kmdo pkg build --auto-snapshot

### 场景5：清理旧产物后构建
#### 功能
构建前删除 dist 目录，避免旧产物干扰，适用于版本迭代时的干净构建。
#### 用法
kmdo pkg build --clean

### 场景6：自定义并发数与超时时间
#### 功能
调整并发构建任务数（优化速度）和超时时间（适配大型项目）。
#### 用法
# 4个并发任务，30分钟超时
kmdo pkg build -p 4 --timeout 30m
```
## 关键行为说明
### 1. 配置文件加载优先级
- 若指定 --config，则加载该路径的配置文件。
- 未指定则默认查找项目根目录的 .kmdopkg.yaml。

### 2. 快照构建的特殊行为
- --snapshot 模式下会自动跳过校验步骤（skips.Validate）。
- --auto-snapshot 会检测Git仓库状态，若有未提交变更则自动启用 --snapshot。

### 3. --output 生效条件
仅当同时满足以下条件时，--output 才会生效：
- 启用 --single-target（单目标构建）。
- 仅指定一个构建ID（--id 单值）或配置文件中仅定义一个 Build。

### 4. 构建产物路径
- 默认输出到 dist 目录，路径格式由配置文件定义。
- 启用 --output 后，会将构建产物复制到指定路径（支持相对路径和绝对路径）。

## 注意事项
1. 并发数配置：--parallelism 建议不超过CPU核心数，过高可能导致资源竞争降低效率。
2. 超时时间：大型项目需适当延长 --timeout（默认1小时），避免构建中断。
3. 构建ID有效性：使用 --id 时，需确保ID在配置文件的 Builds 中存在，否则会报错“无对应构建任务”。
4. Git仓库状态：--auto-snapshot 依赖Git，需确保项目已初始化Git仓库，否则不会触发自动快照。
5. 跳过步骤：--skip 仅支持 skips.Build 定义的有效值，具体可通过命令补全查看支持的选项。
