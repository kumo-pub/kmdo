---
slug: /cmd/mirror/publish
---

# kmdo mirror publish 命令文档
## 概述
kmdo mirror publish 命令用于将组件的二进制包和对应的清单文件发布到镜像仓库，通过自动化校验、文件复制、哈希计算、版本记录创建及 Git 提交流程，完成组件的镜像发布，发布后的元数据将存储在镜像仓库中，供后续部署或分发使用。

## 命令结构
kmdo mirror publish [FLAGS]

## 核心功能
1. 校验输入的二进制包和清单文件有效性。
2. 将清单文件复制到镜像仓库中对应组件的目录。
3. 计算组件目录的 Git 树哈希（Tree Hash）。
4. 生成包含版本、发布渠道、树哈希等元数据的版本记录。
5. 以指定的作者信息提交变更到镜像仓库。
6. 输出发布成功后的关键信息摘要（组件名、渠道、文件路径等）。

## 命令 Flags 说明
| Flag | 简写 | 类型 | 默认值 | 是否必填 | 描述 |
|------|------|------|--------|----------|------|
| --binary | -b | 字符串 | "" | 是 | 组件二进制包路径（如 dist/kmdo-1.1.2-linux-amd64.tar.gz） |
| --manifest | -m | 字符串 | "" | 是 | 清单文件路径（包含版本、SHA256 等信息，如 dist/kmdo-1.1.2-linux-amd64.manifest.json） |
| --component | -c | 字符串 | "" | 是 | 组件名称（必须为小写，如 kmdo） |
| --name | -n | 字符串 | "kmdo" | 否 | 发布者名称 |
| --email | -e | 字符串 | "kumo-pub@outlook.com" | 否 | 发布者邮箱 |
| --channel | -C | 字符串 | "nightly" | 否 | 发布渠道（可选值：stable/beta/nightly） |

## 前置条件
1. 已配置有效的镜像仓库（可通过 `kmdo mirror show` 确认本地工作区和远程源配置）。
2. 二进制包（--binary）和清单文件（--manifest）已存在且路径正确。
3. 组件名称（--component）符合小写要求，且已在镜像索引中注册（可通过 `kmdo mirror list` 确认）。
4. 清单文件中包含组件版本信息（版本号将从清单中自动提取，无需额外指定）。

## 详细使用说明
### 用法

必须指定必填 Flags（--binary/-b、--manifest/-m、--component/-c），可选 Flags 根据需求补充：

```shell
kmdo mirror publish \
  --binary <二进制包路径> \
  --manifest <清单文件路径> \
  --component <组件名称> \
  [--name <发布者名称>] \
  [--email <发布者邮箱>] \
  [--channel <发布渠道>]
```

### 示例
#### 示例1：完整配置发布（指定所有信息）
kmdo mirror publish \
  -b dist/kmdo-1.1.2-linux-amd64.tar.gz \
  -m dist/kmdo-1.1.2-linux-amd64.manifest.json \
  -c kmdo \
  -n "kmdo team" \
  -e "team@kmdo.com" \
  -C stable

#### 示例2：使用默认发布者和渠道
kmdo mirror publish \
  -b dist/app-2.0.0-darwin-amd64.tar.gz \
  -m dist/app-2.0.0-darwin-amd64.manifest.json \
  -c myapp

#### 示例3：发布到 beta 渠道
kmdo mirror publish \
  -b dist/utils-3.0.0-windows-amd64.zip \
  -m dist/utils-3.0.0-windows-amd64.manifest.json \
  -c utils \
  -C beta

## 输出说明
### 发布成功输出
publish successful!
Component:    kmdo
Version:      derived from manifest
Channel:      stable
Binary:       dist/kmdo-1.1.2-linux-amd64.tar.gz
Manifest:     dist/kmdo-1.1.2-linux-amd64.manifest.json
Publisher:    `kmdo team <team@kmdo.com>`

### 错误输出
#### 1. 缺少必填参数
error: required flag(s) "binary", "component", "manifest" not set

#### 2. 组件名称非小写
Component name must lowwer case

#### 3. 二进制包/清单文件不存在
failed to access binary file: open dist/kmdo-1.1.2-linux-amd64.tar.gz: no such file or directory

#### 4. 镜像仓库未配置
failed to get mirror config: local workspace not set, use `kmdo mirror set <local-dir>` first

## 注意事项
1. 组件名称（--component）必须严格小写，否则会直接报错，需提前确认命名规范。
2. 清单文件是核心依赖，需确保包含版本号、文件哈希（如 SHA256）等关键信息，否则发布过程中可能校验失败。
3. 发布渠道（--channel）仅支持 stable/beta/nightly 三个选项，输入其他值会导致参数校验失败。
4. 发布后变更会直接提交到镜像仓库的本地工作区，如需同步到远程仓库，需后续执行 `kmdo mirror push`。
5. 若同一组件同一版本已发布，重新发布会覆盖原有记录（建议通过版本号区分不同发布版本）。

## 发布流程说明
1. 参数校验：检查必填参数是否齐全、组件名称是否小写、文件路径是否有效。
2. 文件校验：验证二进制包和清单文件的可读性、完整性。
3. 文件复制：将清单文件复制到镜像仓库中 `<组件名称>` 对应的目录下。
4. 哈希计算：生成组件目录的 Git 树哈希，用于版本一致性校验。
5. 元数据生成：从清单中提取版本号，结合渠道、发布者信息创建版本记录。
6. Git 提交：以指定的作者信息提交所有变更到镜像仓库本地工作区。
7. 结果输出：打印发布成功的关键信息摘要。