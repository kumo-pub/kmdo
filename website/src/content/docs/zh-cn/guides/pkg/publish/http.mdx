---
title: HTTP 上传
sidebar:
  label: HTTP 上传
description: 'HTTP 上传 配置.'
i18nReady: true
---

kmdo 支持通过简单的 HTTP 请求构建产物并推送到 HTTP 服务器。

## 工作原理

可配置多个 `uploads` 实例，`builds` 章节生成的所有二进制产物将推送到每个配置的上传目标。

若仅需一个 `uploads` 实例，配置流程十分简便，只需在 `.kmdopkg.yaml` 文件中添加上传目标地址和名称即可：

```yaml
uploads:
  - name: production
    target: http://some.server/some/path/example-repo-local/{{ .ProjectName }}/{{ .Version }}/
```

前置条件：

- 可接收 HTTP 请求的 HTTP 服务器
- 具备产物上传权限的用户账号+密码 / 客户端 X.509 证书 / API 密钥

:::note

身份认证为可选配置，仅当服务器要求时需提供：
    - 用户账号+密码：用于基础认证（Basic Authentication）
    - 客户端 X.509 证书：用于双向 TLS 认证（即 "mTLS"）
:::

### 上传目标（Target）

`target` 是产物上传的 URL 模板（**不含产物文件名**）。

以下是 kmdo 上传模式为 `binary` 时，包含 `target` 的示例配置：

```yaml
- name: production
  mode: binary
  target: "http://some.server/some/path/example-repo-local/{{ .ProjectName }}/{{ .Version }}/{{ .Os }}/{{ .Arch }}{{ if .Arm }}{{ .Arm }}{{ end }}"
```

最终会向以下地址发送 HTTP PUT 请求：
`http://some.server/some/path/example-repo-local/kmdo/1.0.0/Darwin/x86_64/kmdo`。

支持的变量：

- `Version`
- `Tag`
- `ProjectName`
- `ArtifactName`
- `Os`
- `Arch`
- `Arm`

:::tip

    变量 `Os`、`Arch` 和 `Arm` 仅在上传模式为 `binary` 时支持。
:::

对于 `archive` 模式，还会包含由 `nfpm` 等工具生成的 `LinuxPackage` 类型（即 Linux 软件包类型）。

### 用户名（Username）

配置的用户名需通过 HTTP 服务器的有效性验证。

用户名可直接在配置文件中设置（如上述示例），也可从环境变量中读取：
- 环境变量名称由 HTTP 服务器配置的 `name` 生成，支持多实例认证场景
- 要求每个配置实例的 `name` 在 kmdo 配置中唯一
- 环境变量格式：`UPLOAD_<实例名称>_USERNAME`（实例名称自动转为大写）
  示例：若实例名称为 `production`，用户名可存储在环境变量 `UPLOAD_PRODUCTION_USERNAME` 中

若配置文件中已指定用户名，则不会读取环境变量中的值。

该字段为可选配置，仅用于 HTTP 基础认证。

### 密码（Password）

密码需存储在环境变量中：
- 环境变量名称由 HTTP 服务器配置的 `name` 生成，支持多实例认证场景
- 要求每个配置实例的 `name` 在 kmdo 配置中唯一
- 环境变量格式：`UPLOAD_<实例名称>_SECRET`（实例名称自动转为大写）
  示例：若实例名称为 `production`，密码需存储在环境变量 `UPLOAD_PRODUCTION_SECRET` 中

该字段为可选配置，仅用于 HTTP 基础认证。

### 基于 X.509 证书的客户端授权（mTLS / 双向 TLS）

若产物服务器支持 mTLS（客户端证书）授权，可通过指定 PEM 编码的 X.509 证书/密钥对文件路径来配置：

```yaml
uploads:
  - name: production
    client_x509_cert: path/to/client.cert.pem
    client_x509_key: path/to/client.key.pem
    target: "http://some.server/some/path/example-repo-local/{{ .ProjectName }}/{{ .Version }}/{{ .Os }}/{{ .Arch }}{{ if .Arm }}{{ .Arm }}{{ end }}"
```

在 TLS 握手过程中，客户端会提供该证书，产物服务器可通过此证书对您进行身份验证
并授权上传权限。

### 服务器认证

可在上传配置中添加受信任的 X.509 证书链，以验证 TLS 服务器的身份。

该受信任证书链将用于校验服务器证书的有效性。

通过 `trusted_certificates` 配置项设置受信任证书链，证书需为 PEM 编码格式，
并以 YAML 文字块（literal block）形式填写，示例如下：

```yaml
uploads:
  - name: "some HTTP/TLS server"
    #...(other settings)...
    trusted_certificates: |
      -----BEGIN CERTIFICATE-----
      MIIDrjCCApagAwIBAgIIShr2zchZo+8wDQYJKoZIhvcNAQENBQAwNTEXMBUGA1UE
      ...(edited content)...
      TyzMJasj5BPZrmKjJb6O/tOtEIJ66xPSBTxPShkEYHnB7A==
      -----END CERTIFICATE-----
      -----BEGIN CERTIFICATE-----
      MIIDrjCCApagAwIBAgIIShr2zchZo+8wDQYJKoZIhvcNAQENBQAwNTEXMBUGA1UE
      ...(edited content)...
      TyzMJasj5BPZrmKjJb6O/tOtEIJ66xPSBTxPShkEYHnB7A==
      -----END CERTIFICATE-----
```

## 自定义配置

当然，您可以对多项参数进行自定义配置：

```yaml title=".kmdopkg.yaml"
uploads:
  # 支持配置多个上传实例
  - # 上传实例的唯一名称，用于标识该实例
    name: production

    # HTTP 请求方法
    #
    # 默认值：'PUT'
    method: POST

    # 需上传的产物 ID 列表
    ids:
      - foo
      - bar

    # 按文件扩展名过滤产物
    # 适用于同一 ID 对应多个不同扩展名的产物（如 nFPM 生成的软件包），
    # 可将不同扩展名的产物上传到不同目标地址
    exts:
      - deb  # Debian 系软件包
      - rpm  # RHEL 系软件包

    # 上传模式，有效值为 `binary`（二进制文件）和 `archive`（归档文件）
    #
    # 若为 `archive` 模式：target 中不支持 _Os_、_Arch_、_Arm_ 变量（变量值为空）
    # 若为 `binary` 模式：需在 archives 配置中同步设置 format: "binary"
    #
    # 默认值：'archive'
    mode: archive

    # HTTP 请求的目标 URL
    #
    # 支持模板语法
    target: https://some.server/some/path/example-repo-local/{{ .ProjectName }}/{{ .Version }}/

    # 自定义产物名称
    # 启用后，需在 Target URL 中包含产物名称（不会自动追加到 URL 末尾）
    # 预计算的产物名称可通过 _ArtifactName_ 变量引用，示例：
    # target: https://some.server/some/path/example-repo-local/{{ .ArtifactName }};deb.distribution=xenial
    custom_artifact_name: true

    # 基础认证（Basic Auth）的可选用户名
    #
    # 支持模板语法（v2.12 及以上版本）
    username: deployuser

    # 基础认证（Basic Auth）的可选密码
    #
    # 支持模板语法
    # <!-- md:inline_version v2.12 -->（v2.12 及以上版本支持）
    password: '{{ readFile "~/.config/foo" }}'  # 从文件读取密码

    # 客户端 X.509 证书和密钥（提供后会添加到 TLS 连接的客户端证书中）
    client_x509_cert: /path/to/client.cert.pem  # 客户端证书路径（PEM 格式）
    client_x509_key: /path/to/client.key.pem    # 客户端密钥路径（PEM 格式）

    # 可选请求头，用于在上传请求中传递产物的 SHA256 校验和
    # 格式：-<自定义头名称>（前缀 "-" 表示仅传递校验和值，不含键名）
    checksum_header: -X-SHA256-Sum

    # 自定义请求头映射，用于支持必填内容类型或自定义认证方案等场景
    custom_headers:
      JOB-TOKEN: "{{ .Env.CI_JOB_TOKEN }}"  # 从环境变量读取 CI 任务令牌

    # 是否上传校验和文件
    checksum: true

    # 是否上传 metadata.json 和 artifacts.json 元数据文件
    meta: true

    # 是否上传签名文件
    signature: true

    # 跳过当前上传配置
    #
    # 支持模板语法
    skip: "{{gt .Patch 0}}"  # 当补丁版本号（Patch）大于 0 时跳过

    # 用于验证服务器证书的受信任证书链（PEM 编码）
    # 以 YAML 文字块（literal block）形式填写
    trusted_certificates: |
      -----BEGIN CERTIFICATE-----
      MIIDrjCCApagAwIBAgIIShr2zchZo+8wDQYJKoZIhvcNAQENBQAwNTEXMBUGA1UE
      ...(编辑后的证书内容)...
      TyzMJasj5BPZrmKjJb6O/tOtEIJ66xPSBTxPShkEYHnB7A==
      -----END CERTIFICATE-----

    # 额外上传已存在的文件（可选）
    #
    # - 上传后的文件名将取路径的最后一部分（basename）
    # - 若存在同名文件，后定义的会覆盖先定义的
    # - 支持通配符和模板语法
    #
    extra_files:
      - glob: ./path/to/file.txt  # 单个文件
      - glob: ./docs/*.md         # 匹配 docs 目录下所有 .md 文件
      - glob: ./glob/**/to/**/file/**/*  # 多层通配符匹配
      - glob: ./glob/foo/to/bar/file/foobar/override_from_previous  # 覆盖同名文件
      - glob: ./single_file.txt
        # 自定义文件名（仅当 glob 精确匹配单个文件时生效，支持模板语法）
        name_template: file.txt

    # 仅上传 extra_files 中定义的文件
    #
    extra_files_only: true
```
