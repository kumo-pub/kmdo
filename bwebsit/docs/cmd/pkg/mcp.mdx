---
slug: /cmd/pkg/mcp
---

# kmdo pkg mcp 命令文档
## 概述
kmdo pkg mcp 命令用于启动 MCP（Model Context Protocol）服务器，将 kmdo pkg 的核心工具（check、healthcheck、build、init）封装为 MCP 兼容接口，支持通过 MCP 协议远程调用，适用于跨环境、跨平台集成 kmdo 包管理功能。

## 命令结构
kmdo pkg mcp [FLAGS]

## 核心功能
1. 启动 MCP 服务器，基于 MCP 协议提供标准化工具调用接口，默认使用 StdioTransport 传输。
2. 暴露 4 个核心工具：init、healthcheck、build、check，对应 kmdo pkg 同名命令功能。
3. 工具调用采用结构化 JSON 输入输出，便于集成方解析。
4. check 工具支持检测配置文件废弃属性，并返回迁移指导。
5. 服务器携带 kmdo pkg 版本信息（GitVersion），供集成方确认兼容性。

## 支持的 MCP 工具列表
| 工具名称 | 功能描述 | 对应 kmdo pkg 命令 |
|----------|----------|-------------------|
| init | 初始化 kmdo pkg 配置（生成 .kmdopkg.yaml） | kmdo pkg init |
| healthcheck | 检查依赖工具是否安装 | kmdo pkg healthcheck |
| build | 构建当前项目（快照模式、清理旧产物、单目标输出到当前目录） | kmdo pkg build --snapshot --clean --single-target -o . |
| check | 校验配置文件有效性，检测废弃属性 | kmdo pkg check |

## 工具调用参数与输出格式
### 1. init 工具
- 请求参数（initArgs）：无额外参数（空结构体）
- 响应输出（initOutput）：
```json
  {
    "output": "kmdo pkg init 命令完整输出日志（字符串）"
  }
```

### 2. healthcheck 工具
- 请求参数（healthcheckArgs）：无额外参数（空结构体）
- 响应输出（healthcheckOutput）：
```json
  {
    "output": "kmdo pkg healthcheck 命令完整输出日志（字符串）"
  }
```

### 3. build 工具
- 请求参数（buildArgs）：无额外参数（空结构体）
- 响应输出（buildOutput）：

```json
  {
    "output": "kmdo pkg build --snapshot --clean --single-target -o . 命令完整输出日志（字符串）"
  }
```
### 4. check 工具
- 请求参数（checkArgs）：
```json
  {
    "configuration": "配置文件路径（可选，为空时默认查找）"
  }
```

- 响应输出（checkOutput）：
```json
  {
    "message": "校验结果信息（字符串）"
  }
```

  - 配置有效：返回 `Configuration at \"<路径>\" is valid!`
  - 含废弃属性：返回废弃属性列表及迁移指导
  - 配置无效：返回错误信息（如 "configuration is invalid: missing required field 'builds'"）

## 废弃属性迁移指导（check 工具专属）
| 废弃属性路径 | 迁移指导 |
|--------------|----------|
| archives.builds | 替换 `builds` 为 `ids` |
| archives.format | 替换 `format` 为 `formats`，值改为数组类型 |
| archives.format_overrides.format | 替换 `format` 为 `formats`，值改为数组类型 |
| builds.gobinary | 重命名 `gobinary` 为 `tool` |
| homebrew_casks.manpage | 替换 `manpage` 为 `manpages`，值改为数组类型 |
| homebrew_casks.conflicts.formula | 从 `conflicts` 列表移除 `formula: <name>` 配置 |
| kos.repository | 替换 `repository` 为 `repositories`，值改为数组类型 |
| kos.sbom | `sbom` 仅支持 `spdx` 或 `none`，其他值改为 `spdx` |
| nfpms.builds | 重命名 `builds` 为 `ids` |
| nightly.name_template | 重命名 `name_template` 为 `version_template` |
| snaps.builds | 重命名 `builds` 为 `ids` |
| snapshot.name_template | 重命名 `name_template` 为 `version_template` |

## 详细使用场景与说明
### 场景1：启动 MCP 服务器
- 用法：kmdo pkg mcp
- 说明：启动后服务器监听标准输入输出，等待 MCP 工具调用，无额外日志输出。

### 场景2：MCP 调用 check 工具示例
- 请求（JSON）：
```json
  {
    "tool": "check",
    "args": {
      "configuration": ".kmdopkg.yaml"
    }
  }
```

- 响应（配置有效）：

```json
  {
    "output": {
      "message": "Configuration at \".kmdopkg.yaml\" is valid!"
    }
  }
```

- 响应（含废弃属性）：
```json
  {
    "output": {
      "message": "Configuration is valid, but uses the following deprecated properties:\n## builds.gobinary\n\nInstructions: rename `gobinary` to `tool`\n\n## archives.format\n\nInstructions: replace `format` with `formats` and make its value an array\n\n"
    }
  }
```

## 注意事项
1. 依赖 MCP 协议：集成方需遵循 MCP 协议规范发起工具调用，确保输入输出格式匹配。
2. 运行环境：服务器启动后会占用当前终端，关闭终端则服务器停止，后台运行需结合进程管理工具（如 nohup、systemd）。
3. 权限要求：工具调用时的权限依赖当前运行 kmdo pkg mcp 命令的用户权限（如构建、文件写入权限）。
4. 配置文件路径：check 工具的 configuration 参数支持相对路径和绝对路径，相对路径以服务器运行目录为基准。
5. 版本兼容性：集成方需确认 kmdo pkg 版本与自身 MCP 客户端的兼容性，服务器会暴露版本信息供校验。
