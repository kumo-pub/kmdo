---
slug: /cmd/pkg/config
---
# kmdo 配置文件加载逻辑文档
## 概述
kmdo 配置文件加载逻辑（`loadConfig` 和 `loadConfigCheck` 函数）用于读取项目的 kmdo 包配置（.kmdopkg.yaml 等），支持指定路径加载、默认路径自动查找、标准输入读取，同时处理 Pro 版配置兼容和严格模式校验，是所有依赖配置的命令（如 build、init、check）的核心基础。

## 核心功能
1. 多路径自动查找：按固定优先级查找项目内的配置文件，无需手动指定路径。
2. 灵活加载方式：支持指定文件路径、读取标准输入（- 表示）、默认路径查找三种模式。
3. Pro 版配置兼容：OSS 版本检测到 `pro: true` 时，可选择忽略 Pro 特性或严格报错。
4. 错误处理：区分“文件不存在”和“配置格式错误”，仅在格式错误时返回异常。

## 配置文件查找优先级（默认模式）
当未指定配置文件路径时，按以下顺序查找，找到第一个存在的文件即加载：
1. .config/kmdopkg.yml
2. .config/kmdopkg.yaml
3. .kmdopkg.yml
4. .kmdopkg.yaml
5. kmdopkg.yml
6. kmdopkg.yaml

### 未找到配置文件时的行为
- 不返回错误，返回空配置（使用默认值）。
- 输出警告日志：`⚠️  could not find a configuration file, using defaults...`

## 支持的加载方式
### 1. 指定文件路径加载
- 用法：通过 `--config/-f` 标志指定文件路径（如 `kmdo pkg build -f ./custom.yml`）。
- 支持格式：仅 yaml/yml 格式文件。
- 错误场景：文件不存在或格式无效时，返回对应错误。

### 2. 标准输入读取
- 用法：指定路径为 `-`（如 `cat config.yml | kmdo pkg check -f -`）。
- 场景：适用于管道传输配置内容，无需本地文件。

### 3. 默认路径自动查找
- 用法：不指定 `--config/-f` 标志，自动按优先级查找配置文件。
- 场景：大多数日常开发场景，简化命令输入。

## Pro 版配置兼容逻辑
### 检测条件
配置文件中包含 `pro: true` 时，触发 Pro 版配置检测。

### 严格模式（strict=true）
- 触发场景：由调用方指定（如 `loadConfig(true, path)`），通常用于发布、校验等关键流程。
- 行为：直接返回 `config.ErrProConfig` 错误，阻止操作执行。

### 非严格模式（strict=false）
- 触发场景：默认模式（如 `loadConfig(false, path)`），通常用于构建、本地开发等流程。
- 行为：忽略 Pro 专属特性，继续执行操作。
- 输出警告日志，包含说明：`⚠️  your configuration specifies pro: true - Your configuration is for kmdo Pro. You are currently using kmdo OSS, so all the Pro-only features will be ignored. Use kmdo Pro to enable all the features.`

## 函数调用关系与参数说明
### 1. loadConfigCheck(path string) (config.Project, string, error)
- 作用：底层加载函数，负责实际读取配置文件或标准输入。
- 参数 `path`：配置文件路径（空字符串表示默认查找，`-` 表示标准输入）。
- 返回值：
  - `config.Project`：加载后的配置对象（空配置表示未找到文件）。
  - `string`：实际加载的文件路径（或 `-` 表示标准输入，空字符串表示未找到文件）。
  - `error`：加载错误（格式错误、读取失败等；文件不存在时不返回错误）。

### 2. loadConfig(strict bool, path string) (config.Project, error)
- 作用：上层封装函数，处理 Pro 配置兼容和日志输出。
- 参数：
  - `strict`：是否启用严格模式（Pro 配置检测）。
  - `path`：配置文件路径（同 `loadConfigCheck`）。
- 返回值：
  - `config.Project`：加载后的配置对象。
  - `error`：加载错误（严格模式下 Pro 配置会返回错误，其他错误同 `loadConfigCheck`）。

## 常见错误场景与处理
| 错误类型 | 触发条件 | 处理方式 |
|----------|----------|----------|
| 配置格式错误 | 文件内容不符合 YAML 规范，或字段不合规 | 返回错误信息，终止依赖配置的命令 |
| 文件不存在 | 指定的路径文件不存在 | 若为默认查找模式，返回空配置；若为指定路径模式，返回 `fs.ErrNotExist` 错误 |
| Pro 配置检测 | 配置文件包含 `pro: true` 且严格模式启用 | 返回 `config.ErrProConfig` 错误，终止操作 |
| 读取权限不足 | 指定的文件或路径无读取权限 | 返回权限错误信息，终止操作 |

## 注意事项
1. 配置文件优先级：指定路径 > 标准输入 > 默认路径查找，一旦指定路径，将忽略默认查找逻辑。
2. 空配置兼容：未找到配置文件时，返回空配置，依赖配置的命令会使用内置默认值（如构建命令默认构建当前语言的单目标）。
3. Pro 特性忽略：OSS 版本中，Pro 专属配置项（如高级构建规则、多镜像发布）会被自动忽略，不影响基础功能使用。
4. 日志输出：加载过程中的关键信息（如使用的配置路径、Pro 配置警告）会通过日志打印，便于问题排查。