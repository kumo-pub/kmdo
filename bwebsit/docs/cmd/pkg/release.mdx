---
slug: /cmd/pkg/release
---

# kmdo pkg release 命令文档
## 概述
kmdo pkg release 命令用于自动化完成项目发布全流程，包括构建二进制产物、生成发布说明、发布制品到配置的仓库（如 GitHub Releases），支持快照发布、草稿发布、自定义发布说明等功能，是项目版本迭代的核心命令，适配从开发测试到正式发布的全场景需求。

## 命令结构
kmdo pkg release [FLAGS]
kmdo pkg r [FLAGS]  # 简写形式

## 核心功能
1. 全流程自动化：整合构建、校验、发布说明生成、制品发布等步骤，无需手动干预。
2. 灵活发布模式：支持正式发布、快照发布（无版本号，跳过校验）、草稿发布（仅创建不公开）。
3. 自定义发布说明：支持加载静态 Markdown 文件或模板化文件，可自定义头部、底部内容。
4. 环境适配优化：自动识别 Git 仓库状态，支持脏仓库自动触发快照发布。
5. 容错与控制：支持快速失败（首错即停）、并发任务控制、超时保护，适配大型项目发布。
6. 可跳过步骤：支持选择性跳过发布流程中的特定步骤（如跳过公告、发布校验）。

## 命令 Flags 说明
| Flag | 简写 | 类型 | 默认值 | 描述 |
|------|------|------|--------|------|
| --config | -f | 字符串 | "" | 加载配置文件路径（支持 yaml/yml 格式，默认按优先级查找项目内配置文件） |
| --release-notes | - | 字符串 | "" | 加载自定义发布说明（Markdown 文件），跳过自动生成变更日志 |
| --release-header | - | 字符串 | "" | 加载发布说明头部内容（Markdown 文件） |
| --release-footer | - | 字符串 | "" | 加载发布说明底部内容（Markdown 文件） |
| --release-notes-tmpl | - | 字符串 | "" | 加载模板化发布说明（Markdown 文件），覆盖 --release-notes |
| --release-header-tmpl | - | 字符串 | "" | 加载模板化发布说明头部（Markdown 文件），覆盖 --release-header |
| --release-footer-tmpl | - | 字符串 | "" | 加载模板化发布说明底部（Markdown 文件），覆盖 --release-footer |
| --auto-snapshot | - | 布尔值 | false | Git 仓库有未提交变更时，自动触发 --snapshot 模式 |
| --snapshot | - | 布尔值 | false | 生成无版本号快照发布，跳过校验/发布/公告步骤 |
| --draft | - | 布尔值 | false | 创建草稿发布（覆盖配置文件中 release.draft 配置） |
| --fail-fast | - | 布尔值 | false | 发布过程中遇到第一个错误即终止，不继续执行 |
| --clean | - | 布尔值 | false | 发布前删除 dist 目录（清理旧构建产物） |
| --parallelism | -p | 整数 | 0 | 并发任务数（默认等于 CPU 核心数） |
| --timeout | - | 时长 | 1小时 | 整个发布流程的超时时间（如 2h 表示2小时） |
| --deprecated | - | 布尔值 | false | 强制打印废弃提示（仅测试用，默认隐藏） |
| --skip | - | 字符串切片 | [] | 跳过指定发布步骤（有效值参考 skips.Release 定义） |

## 关键发布模式说明
### 1. 正式发布（默认模式）
- 触发条件：未启用 --snapshot、--auto-snapshot 未触发。
- 核心行为：执行完整发布流程（构建 → 校验 → 生成发布说明 → 发布制品 → 发送公告）。
- 适用场景：项目稳定版本迭代，需公开对外发布的正式版本。

### 2. 快照发布（--snapshot/--auto-snapshot）
- 触发条件：手动指定 --snapshot，或 --auto-snapshot 且 Git 仓库为脏状态（有未提交变更）。
- 核心行为：
  - 生成无版本号的快照产物，跳过版本校验。
  - 自动跳过 publish（制品发布）、announce（公告）、validate（校验）步骤。
  - 不公开发布，仅用于开发测试、内部验证。
- 适用场景：开发过程中快速生成测试版本，无需遵循严格版本规范。

### 3. 草稿发布（--draft）
- 触发条件：手动指定 --draft。
- 核心行为：发布流程与正式发布一致，但生成的发布记录为“草稿”状态（不公开），可后续编辑后再发布。
- 适用场景：需要先预览发布内容（如发布说明、制品），确认无误后再正式公开。

## 发布说明自定义逻辑
### 1. 优先级顺序（从高到低）
1. 模板化文件（--release-notes-tmpl > --release-notes）
2. 静态文件（--release-notes > 自动生成的变更日志）
3. 头部/底部内容：模板化文件（--release-header-tmpl/--release-footer-tmpl）覆盖静态文件（--release-header/--release-footer）

### 2. 支持格式
- 静态文件：普通 Markdown 文件（.md/.mkd/.markdown），直接读取内容。
- 模板化文件：支持模板语法的 Markdown 文件，可注入动态变量（如版本号、构建时间等，具体变量以配置为准）。

## 流程控制与容错
### 1. 并发控制
- 通过 --parallelism 指定并发任务数，默认使用 CPU 核心数，优化构建、发布等步骤的执行速度。
- 大型项目可适当降低并发数，避免资源竞争导致的失败。

### 2. 超时保护
- 通过 --timeout 设置整个发布流程的超时时间（默认1小时），防止因网络阻塞、任务卡死等导致无限等待。
- 超时后自动终止发布流程，返回错误。

### 3. 快速失败
- 启用 --fail-fast 后，发布过程中遇到第一个错误（如构建失败、发布失败）即终止，避免无效执行。
- 未启用时，会尝试执行所有步骤，仅在最后汇总错误。

### 4. 步骤跳过
- 通过 --skip 指定要跳过的步骤（如 --skip=announce 跳过公告发送），支持多个步骤（用逗号分隔）。
- 快照发布模式下，自动跳过 publish、announce、validate 步骤，无需手动指定。

## 详细使用场景与说明
### 场景1：正式发布（默认流程）
#### 用法
kmdo pkg release
#### 适用场景
发布稳定版本，执行完整流程（构建 → 校验 → 发布说明生成 → 制品发布 → 公告）。
#### 输出示例
-  loading configuration from .kmdopkg.yaml
-  parallelism: 8
-  starting release pipeline
-  building binaries...
-  generating release notes...
-  publishing artifacts...
-  sending announce...
- release succeeded after 2m30s

### 场景2：快照发布（开发测试）
#### 用法
# 手动触发快照发布
kmdo pkg release --snapshot

# 脏仓库自动触发快照发布
kmdo pkg release --auto-snapshot
#### 输出示例
-  git repository is dirty and --auto-snapshot is set, implying --snapshot
-  skipping validate, publish, announce steps...
-  building snapshot binaries...
-  release succeeded after 45s

### 场景3：草稿发布（预览内容）
#### 用法
kmdo pkg release --draft
#### 输出示例
-  creating draft release...
-  building binaries...
-  generating release notes...
-  publishing artifacts (draft mode)...
- release succeeded after 1m50s
-  release is in draft mode, visit the repository to publish it

### 场景4：自定义发布说明
#### 用法
# 使用静态发布说明文件
kmdo pkg release --release-notes ./RELEASE.md

# 使用模板化发布说明+自定义头部
kmdo pkg release --release-notes-tmpl ./RELEASE.tmpl.md --release-header ./HEADER.md

### 场景5：控制并发与超时
#### 用法
# 4个并发任务，30分钟超时
kmdo pkg release -p 4 --timeout 30m

### 场景6：跳过指定步骤
#### 用法
# 跳过公告发送步骤
kmdo pkg release --skip=announce

# 跳过校验和公告步骤
kmdo pkg release --skip=validate,announce

## 注意事项
1. 配置文件依赖：发布流程依赖配置文件中定义的发布仓库（如 GitHub 令牌、仓库地址）、构建规则等，需提前配置完整。
2. Git 仓库要求：正式发布建议在干净的 Git 仓库（无未提交变更）中执行，避免快照发布自动触发。
3. 权限说明：发布制品到远程仓库（如 GitHub Releases）需确保当前环境有足够权限（如配置了正确的访问令牌）。
4. 模板变量：使用模板化发布说明文件时，需了解支持的动态变量（参考官方文档），避免变量不存在导致的渲染失败。
5. 快照发布特性：快照发布不生成正式版本号，也不发布到公开仓库，仅用于内部测试，请勿用于生产环境。

要不要我帮你整理一份 **kmdo pkg release 命令常见问题排查指南**，包含发布失败的常见场景（如权限不足、配置错误、网络问题）、日志解读和解决方案，方便快速定位问题？