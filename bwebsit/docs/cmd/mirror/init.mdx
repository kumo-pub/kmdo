---
slug: /cmd/mirror/init
---
# kmdo mirror init 命令文档

## 概述
kmdo mirror init 命令用于初始化二进制组件的本地镜像仓库，支持三种模式：创建空镜像仓库、从远程仓库克隆镜像、使用全局配置初始化官方镜像，同时提供强制覆盖、指定分支等灵活配置选项。

## 命令结构
kmdo mirror init [local-dir] [remote] [FLAGS]

## 核心功能
1. 初始化空本地镜像仓库（仅指定本地目录）。
2. 从指定远程仓库克隆镜像到本地（指定本地目录+远程URL）。
3. 基于全局配置初始化官方镜像（省略参数，使用默认配置）。
4. 支持指定目标分支、强制覆盖现有目录（忽略确认直接执行）。

## 命令 Flags 说明
| Flag | 简写 | 类型 | 默认值 | 描述 |
|------|------|------|--------|------|
| --branch | -b | 字符串 | master | 指定克隆或初始化的目标分支（如 main、dev 等） |
| --force | -f | 布尔值 | false | 跳过用户确认，强制初始化（现有目录及数据将被删除，不可逆） |

## 详细使用场景与说明

### 场景1：初始化空镜像仓库（仅指定本地目录）
#### 功能
在指定本地目录创建一个空的 Git 镜像仓库，基于 --branch 指定的分支初始化（默认 master）。
#### 用法
```shell
kmdo mirror init <local-dir> [--branch <分支名>] [--force]
```
#### 示例
# 默认分支（master）创建空镜像
kmdo mirror init ./my-empty-mirror

# 指定 main 分支创建空镜像
kmdo mirror init ./my-empty-mirror -b main

# 强制创建（若目录已存在，直接删除并重建）
kmdo mirror init ./my-empty-mirror -f

#### 执行逻辑
- 若目录不存在：直接创建目录并初始化空 Git 镜像仓库。
- 若目录已存在：
  - 非 Git 目录：提示删除目录后重建空镜像。
  - Git 目录：提供交互式选择（1. 保留配置重置、2. 完全清理重建、3. 取消操作），--force 模式下默认选择 1。

### 场景2：从远程仓库克隆镜像（指定本地目录+远程URL）
#### 功能
从指定远程 Git 仓库克隆内容到本地目录，创建镜像仓库，支持指定分支克隆。
#### 用法

```shell
kmdo mirror init <local-dir> <remote-url> [--branch <分支名>] [--force]
```
#### 示例
# 从远程仓库克隆到本地 my-remote-mirror 目录（默认 master 分支）
kmdo mirror init ./my-remote-mirror https://github.com/kumose/mirror-repo.git

# 指定 dev 分支克隆，强制覆盖现有目录
kmdo mirror init ./my-remote-mirror https://github.com/kumose/mirror-repo.git -b dev -f

#### 执行逻辑
1. 检查本地目录是否存在，存在则提示确认删除（--force 跳过确认）。
2. 执行 Git 克隆命令，拉取远程仓库指定分支内容到本地目录。
3. 克隆成功后，提示使用 `kmdo mirror set <local-dir>` 设置为当前镜像工作区。

### 场景3：使用全局配置初始化官方镜像（省略参数）
#### 功能
读取全局配置中的远程仓库地址（mr.MirrorCtx.RootConfig.Remote）和本地目录（mr.MirrorCtx.RootConfig.LocalDir），自动克隆官方镜像。
#### 用法

```shell
kmdo mirror init [--branch <分支名>] [--force]
```

#### 示例
# 使用全局配置初始化官方镜像（默认 master 分支）
```shell
kmdo mirror init
```

# 强制初始化官方镜像（覆盖现有目录）
```shell
kmdo mirror init -f
```

#### 执行逻辑
1. 读取全局配置中的远程地址和本地目录参数。
2. 检查本地目录是否存在，存在则删除（--force 跳过确认）。
3. 克隆官方远程仓库到配置的本地目录，完成后提示初始化成功。

## 关键辅助逻辑说明
### 1. 目录状态检测
执行前会自动检测目标目录状态：
- 不存在：直接创建并初始化。
- 存在且为 Git 仓库：提供交互式重置选项。
- 存在且非 Git 仓库：提示删除后重建。

### 2. 确认与强制机制
- 非 --force 模式：删除目录前会弹出确认提示（需手动输入确认）。
- --force 模式：直接删除目录并执行初始化，无任何确认步骤（谨慎使用）。

### 3. Git 仓库重置选项（交互式模式）
当目标目录是现有 Git 仓库时，提供三种操作：
1. 保存配置并重置：保留 Git 配置，清空历史记录和文件，重新初始化指定分支。
2. 完全清理并重建：删除整个目录，从零开始创建新镜像仓库。
3. 取消操作：终止初始化流程，不做任何修改。

## 输出说明
### 成功输出
- 空镜像初始化成功：`using kmdo mirror set ./my-empty-mirror set mirror workspace`
- 远程克隆成功：`using kmdo mirror set ./my-remote-mirror set mirror workspace`
- 官方镜像初始化成功：`init offical mirror success`

### 错误输出
- 目录非文件夹：`'./file.txt' is not a directory`
- 用户取消操作：`user canceled` / `operation canceled by user`
- 克隆失败：`failed to clone repository: [具体错误信息]`
- 目录删除失败：`failed to delete existing directory: [具体错误信息]`

## 注意事项
1. --force 标志会直接删除目标目录下所有数据，不可逆，执行前务必确认数据无需保留。
2. 克隆远程仓库时需确保网络通畅，且远程 URL 正确、可访问（需提前配置仓库认证信息如密钥、用户名密码）。
3. 全局配置模式依赖 mr.MirrorCtx.RootConfig 中的远程地址和本地目录配置，未配置时会执行失败。
4. 初始化完成后，需执行 `kmdo mirror set <local-dir>` 将该目录设置为当前镜像工作区，否则后续镜像操作可能无法识别。